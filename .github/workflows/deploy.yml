name: CI/CD Docker Build and Deploy

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: rajveerapp

jobs:
  build-tag:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set_tag.outputs.image_tag }}
    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ·ï¸ Generate Image Tag
        id: set_tag
        run: |
          IMAGE_TAG=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "::set-output name=image_tag=$IMAGE_TAG"

  docker-build-push:
    needs: build-tag
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ§ª Set Environment Variables
        run: |
          echo "IMAGE_TAG=${{ needs.build-tag.outputs.image_tag }}" >> $GITHUB_ENV
          echo "ACR_SERVER=${{ secrets.ACR_LOGIN_SERVER }}" >> $GITHUB_ENV

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ” Docker Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
          password: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

      - name: ğŸ³ Build Docker Image
        run: |
          docker build -t $ACR_SERVER/$IMAGE_NAME:$IMAGE_TAG .

      - name: ğŸ“¤ Push Docker Image to ACR
        run: |
          docker push $ACR_SERVER/$IMAGE_NAME:$IMAGE_TAG

  deploy:
    needs: docker-build-push
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸš€ Deploy to Azure Container App
        run: |
          az containerapp update \
            --name rajveer-app \
            --resource-group YOUR_RESOURCE_GROUP \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/rajveerapp:${{ needs.build-tag.outputs.image_tag }} \
            --container-name rajveer-container \
            --cpu 0.5 \
            --memory 1.0Gi
