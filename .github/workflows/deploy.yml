name: CI/CD:Build â†’ Test â†’ Dockerize â†’ Push â†’ Deploy

on:
  push:
    branches:
      - main

env:
  RESOURCE_GROUP: rajveer
  CONTAINERAPP_NAME: rajveer
  IMAGE_NAME: rajveerapp
  ACR_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}

jobs:
  ci-cd-pipeline:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§± Build Step
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ—ï¸ Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest

      # âœ… Test Step
      - name: âœ… Run Unit Tests
        run: |
          pytest tests || echo "âš ï¸ No tests found, skipping test failures."

      # ğŸ³ Generate Image Tag
      - name: ğŸ·ï¸ Generate Docker Image Tag
        run: |
          IMAGE_TAG=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "FULL_IMAGE=${{ env.ACR_SERVER }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG" >> $GITHUB_ENV

      # ğŸ” Azure & ACR Login
      - name: ğŸ” Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ” Docker Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
          password: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

      # ğŸ“¦ Build Docker Image
      - name: ğŸ³ Build Docker Image
        run: |
          docker build -t ${{ env.FULL_IMAGE }} .

      # ğŸ“¤ Push Docker Image
      - name: ğŸ“¤ Push Image to ACR
        run: |
          docker push ${{ env.FULL_IMAGE }}

      # ğŸ” Check Container App existence
      - name: ğŸ” Check if Container App Exists
        id: checkapp
        run: |
          if az containerapp show --name ${{ env.CONTAINERAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_ENV
          else
            echo "exists=false" >> $GITHUB_ENV
          fi

      # ğŸ†• Create Container App if not exists
      - name: ğŸ†• Create Azure Container App
        if: env.exists == 'false'
        run: |
          az containerapp env create \
            --name rajveer-env \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --location centralindia

          az containerapp create \
            --name ${{ env.CONTAINERAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --environment rajveer-env \
            --image ${{ env.FULL_IMAGE }} \
            --target-port 80 \
            --ingress external \
            --registry-server ${{ env.ACR_SERVER }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }}

      # ğŸš€ Deploy new version if app exists
      - name: ğŸš€ Deploy New Version
        if: env.exists == 'true'
        run: |
          az containerapp update \
            --name ${{ env.CONTAINERAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.FULL_IMAGE }}

      # ğŸŒ Show deployed URL
      - name: ğŸŒ Show Deployed App URL
        run: |
          URL=$(az containerapp show \
            --name ${{ env.CONTAINERAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          echo "ğŸŒ App deployed at: https://$URL"
