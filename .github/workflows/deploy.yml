name: CI/CD:Build, Push, Deploy Azure Container App

on:
  push:
    branches:
      - main

env:
  RESOURCE_GROUP: rajveer
  CONTAINERAPP_NAME: rajveer
  IMAGE_NAME: rajveerapp
  ACR_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ‚¨áÔ∏è Checkout Code
      uses: actions/checkout@v3

    - name: üè∑Ô∏è Generate image tag from commit message
      run: |
        IMAGE_TAG=$(echo "${{ github.event.head_commit.message }}" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '-' | cut -c1-40)
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        echo "FULL_IMAGE=${{ env.ACR_SERVER }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG" >> $GITHUB_ENV

    - name: üîê Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: üîê Log in to ACR
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
        password: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

    - name: üõ†Ô∏è Build Docker image
      run: |
        docker build -t ${{ env.FULL_IMAGE }} .

    - name: üì¶ Push image to ACR
      run: |
        docker push ${{ env.FULL_IMAGE }}

    - name: üì¶ Check if Container App exists
      id: checkapp
      run: |
        az containerapp show --name ${{ env.CONTAINERAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} \
        && echo "exists=true" >> $GITHUB_ENV \
        || echo "exists=false" >> $GITHUB_ENV

    - name: üå± Create Container App if not exists
      if: env.exists == 'false'
      run: |
        # Create an Azure Container App Environment if needed (one-time setup)
        az containerapp env create \
          --name rajveer-env \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --location centralindia

        # Create the Container App
        az containerapp create \
          --name ${{ env.CONTAINERAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --environment rajveer-env \
          --image ${{ env.FULL_IMAGE }} \
          --target-port 80 \
          --ingress external \
          --registry-server ${{ env.ACR_SERVER }}

    - name: üöÄ Update Container App if exists
      if: env.exists == 'true'
      run: |
        az containerapp update \
          --name ${{ env.CONTAINERAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.FULL_IMAGE }}

    - name: üåê Show deployed URL
      run: |
        URL=$(az containerapp show \
          --name ${{ env.CONTAINERAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          -o tsv)
        echo "üåê Visit your app: https://$URL"
